<div class="flex flex-col h-full animate-fade-in-up">

  <!-- Header / Controls -->
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold text-[#111418] dark:text-white">Master Inventory</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">Manage categories, items, and current stock levels across all
        operations.</p>
    </div>

    <button (click)="openAddCategory()"
      class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-600 transition-colors shadow-lg shadow-primary/20">
      <span class="material-symbols-outlined text-[18px]">add</span>
      <span class="hidden sm:inline">Add Category</span>
    </button>
  </div>

  <!-- Content Grid -->
  <div class="flex-1 overflow-y-auto pb-10">
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">

      @for (category of categories(); track category.id) {
      <div
        class="bg-white dark:bg-[#1c2936] rounded-xl border border-gray-200 dark:border-[#324d67] overflow-hidden flex flex-col shadow-sm">
        <!-- Category Header -->
        <div
          class="px-5 py-3 bg-gray-50 dark:bg-[#111a22] border-b border-gray-200 dark:border-[#324d67] flex items-center justify-between">
          <h2 class="font-bold text-[#111418] dark:text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-primary text-[20px]">folder_open</span>
            {{ category.name }}
          </h2>
          <div class="flex items-center gap-2">
            <span
              class="text-xs bg-gray-200 dark:bg-[#253545] text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full font-medium">{{
              category.items.length }} items</span>
            <button (click)="deleteCategory(category.id)"
              class="text-gray-400 hover:text-red-500 p-1 rounded hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors"
              title="Delete Category">
              <span class="material-symbols-outlined text-[18px]">delete</span>
            </button>
          </div>
        </div>

        <!-- Items List -->
        <div class="divide-y divide-gray-100 dark:divide-[#324d67]">
          @for (item of category.items; track item.id) {
          <div
            class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-[#253545] transition-colors group/item">
            <div class="flex flex-col">
              <span class="font-medium text-[#111418] dark:text-white">{{ item.name }}</span>
              <span class="text-xs text-gray-400">ID: {{ item.id }}</span>
            </div>

            <div class="flex items-center gap-4">
              <div class="flex items-center gap-4">
                <span class="text-sm font-bold text-gray-700 dark:text-gray-300">
                  {{ item.price | currency:'USD':'symbol':'1.2-2' }}
                </span>
                <span
                  class="px-3 py-1 bg-gray-100 dark:bg-[#111a22] rounded-lg text-sm font-mono font-bold text-[#111418] dark:text-white border border-gray-200 dark:border-[#324d67]">
                  {{ item.quantity }}
                </span>
                <button (click)="openRefillModal(category.id, item)"
                  class="flex items-center gap-1 px-3 py-1.5 bg-blue-50 dark:bg-blue-900/10 text-primary rounded-lg hover:bg-primary hover:text-white transition-colors text-xs font-bold"
                  title="Refill & Update Price">
                  <span class="material-symbols-outlined text-[16px]">autorenew</span>
                  Refill
                </button>
              </div>

              <!-- Delete Item -->
              <button (click)="deleteItem(category.id, item.id)"
                class="opacity-0 group-hover/item:opacity-100 text-gray-300 hover:text-red-500 transition-all"
                title="Remove Item">
                <span class="material-symbols-outlined text-[20px]">delete</span>
              </button>
            </div>
          </div>
          }
          @if (category.items.length === 0) {
          <div class="p-8 text-center text-gray-400 text-sm italic">
            No items in this category yet.
          </div>
          }
        </div>

        <!-- Add Item Footer -->
        <button (click)="openAddItem(category.id)"
          class="p-3 text-sm text-center font-bold text-primary hover:bg-primary/5 transition-colors border-t border-gray-200 dark:border-[#324d67] flex items-center justify-center gap-2">
          <span class="material-symbols-outlined text-[18px]">add</span>
          Add Item to {{ category.name }}
        </button>
      </div>
      }

      @if (categories().length === 0) {
      <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400">
        <span class="material-symbols-outlined text-6xl mb-4 text-gray-200 dark:text-gray-700">inventory_2</span>
        <p class="text-lg font-medium">No inventory items found</p>
        <p class="text-sm">Try adjusting your search or add a new category.</p>
      </div>
      }
    </div>
  </div>

  <!-- Modal -->
  @if (isModalOpen()) {
  <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
    <div
      class="bg-white dark:bg-[#1c2936] w-full max-w-sm rounded-xl shadow-2xl border border-gray-200 dark:border-[#324d67] overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-[#324d67] flex items-center justify-between">
        <h3 class="text-lg font-bold text-[#111418] dark:text-white">
          @switch (modalType()) {
          @case ('category') { New Category }
          @case ('item') { New Item }
          @case ('refill') { Refill Item }
          }
        </h3>
        <button (click)="isModalOpen.set(false)" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="p-6 space-y-4">
        @if (modalType() === 'refill') {
        <!-- Refill Mode -->
        <div class="space-y-1.5">
          <label class="text-xs font-bold text-gray-500 uppercase">Add Quantity</label>
          <input type="number" [ngModel]="refillQuantity()" (ngModelChange)="refillQuantity.set($event)"
            class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary focus:border-primary transition-colors"
            min="0" autofocus>
          <p class="text-xs text-gray-400">Enter amount to ADD to current stock.</p>
        </div>

        <div class="space-y-1.5">
          <label class="text-xs font-bold text-gray-500 uppercase">Update Price</label>
          <input type="number" [ngModel]="newItemPrice()" (ngModelChange)="newItemPrice.set($event)"
            class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary focus:border-primary transition-colors"
            min="0" step="0.01">
        </div>
        } @else {
        <!-- Standard Add Mode -->
        <div class="space-y-1.5">
          <label class="text-xs font-bold text-gray-500 uppercase">Name</label>
          <input type="text" [ngModel]="newItemName()" (ngModelChange)="newItemName.set($event)"
            class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary focus:border-primary transition-colors"
            placeholder="e.g., Office Supplies" autofocus
            (keyup.enter)="modalType() === 'category' ? submitModal() : null">
        </div>

        @if (modalType() === 'item') {
        <div class="space-y-1.5">
          <label class="text-xs font-bold text-gray-500 uppercase">Unit Price ($)</label>
          <input type="number" [ngModel]="newItemPrice()" (ngModelChange)="newItemPrice.set($event)"
            class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary focus:border-primary transition-colors"
            min="0" step="0.01" (keyup.enter)="submitModal()">
        </div>
        }
        }
      </div>

      <div
        class="px-6 py-4 bg-gray-50 dark:bg-[#111a22] border-t border-gray-200 dark:border-[#324d67] flex justify-end gap-3">
        <button (click)="isModalOpen.set(false)"
          class="px-4 py-2 text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#253545] rounded-lg">Cancel</button>

        @if (modalType() === 'refill') {
        <button (click)="submitRefill()"
          class="px-4 py-2 text-sm font-bold text-white bg-primary hover:bg-blue-600 rounded-lg shadow-lg shadow-primary/20">
          Confirm Refill
        </button>
        } @else {
        <button (click)="submitModal()" [disabled]="!newItemName()"
          class="px-4 py-2 text-sm font-bold text-white bg-primary hover:bg-blue-600 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
          Create
        </button>
        }
      </div>
    </div>
  </div>
  }
</div>