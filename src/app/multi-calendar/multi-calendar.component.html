<div class="flex flex-col h-full animate-fade-in-up">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-6">
    <div>
      <h1 class="text-3xl font-extrabold text-[#111418] dark:text-white tracking-tight">Multi-Calendar</h1>
      <p class="text-gray-500 dark:text-gray-400 mt-1">Availability and bookings across all channels.</p>
    </div>

    <!-- Controls -->
    <div class="flex items-center gap-4">

      <!-- Legend -->
      <div class="hidden xl:flex items-center gap-3 text-xs font-bold text-gray-500 mr-4">
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-[#ff385c]"></span> Airbnb</div>
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-[#003580]"></span> Booking.com</div>
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-[#FFC400]"></span> Expedia</div>
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-[#10b981]"></span> Direct</div>
      </div>

      <div
        class="flex items-center bg-white dark:bg-[#1c2936] rounded-lg border border-gray-200 dark:border-[#324d67] p-1 shadow-sm">
        <button (click)="changeMonth(-1)"
          class="p-2 hover:bg-gray-100 dark:hover:bg-[#253545] rounded-md transition-colors">
          <span class="material-symbols-outlined text-[20px]">chevron_left</span>
        </button>
        <div class="px-4 font-bold min-w-[140px] text-center text-[#111418] dark:text-white select-none">
          {{ formattedMonth() }}
        </div>
        <button (click)="changeMonth(1)"
          class="p-2 hover:bg-gray-100 dark:hover:bg-[#253545] rounded-md transition-colors">
          <span class="material-symbols-outlined text-[20px]">chevron_right</span>
        </button>
      </div>

      <button (click)="goToToday()"
        class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600 transition-colors shadow-lg shadow-primary/20">
        Today
      </button>

      <button (click)="openBookingModal()"
        class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 transition-colors shadow-lg shadow-green-600/20 flex items-center gap-2">
        <span class="material-symbols-outlined text-[18px]">add</span>
        New Booking
      </button>
    </div>
  </div>

  <!-- Calendar Container -->
  <div
    class="flex-1 bg-white dark:bg-[#1c2936] rounded-xl border border-gray-200 dark:border-[#324d67] overflow-hidden flex flex-col shadow-sm">

    <!-- Timeline Header -->
    <div class="flex border-b border-gray-200 dark:border-[#324d67] bg-gray-50 dark:bg-[#111a22]">
      <!-- Sticky Corner -->
      <div
        class="w-48 flex-shrink-0 p-4 font-bold text-gray-500 uppercase text-xs border-r border-gray-200 dark:border-[#324d67] bg-gray-50 dark:bg-[#111a22] z-20">
        Unit / Property
      </div>

      <!-- Days Row -->
      <div #headerScroll class="flex-1 overflow-hidden relative">
        <div class="flex">
          @for (day of currentMonthDays(); track day.dayNum) {
          <div
            class="flex-shrink-0 flex flex-col items-center justify-center border-r border-gray-100 dark:border-[#324d67] h-14"
            [style.width.px]="cellWidth" [class.bg-blue-50]="day.isToday" [class.dark:bg-blue-900/20]="day.isToday"
            [class.bg-gray-100]="day.isWeekend && !day.isToday"
            [class.dark:bg-[#18232e]]="day.isWeekend && !day.isToday">
            <span class="text-[10px] uppercase font-bold text-gray-400">{{ day.dayName }}</span>
            <span class="text-sm font-bold mt-0.5 w-6 h-6 flex items-center justify-center rounded-full"
              [class.bg-primary]="day.isToday" [class.text-white]="day.isToday" [class.text-[#111418]]="!day.isToday"
              [class.dark:text-white]="!day.isToday">
              {{ day.dayNum }}
            </span>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Scrollable Body -->
    <div #bodyScroll class="flex-1 overflow-y-auto overflow-x-auto relative">
      <div class="min-w-max pb-20">

        @for (group of calendarGroups(); track group.name) {

        <!-- Group Header Row -->
        <div
          class="flex border-b border-gray-200 dark:border-[#324d67] bg-gray-50 dark:bg-[#1c2936] hover:bg-gray-100 dark:hover:bg-[#253545] transition-colors cursor-pointer group/header"
          (click)="toggleGroup(group.name)">
          <!-- Sticky Header -->
          <div
            class="w-48 flex-shrink-0 px-4 py-2 flex items-center justify-between border-r border-gray-200 dark:border-[#324d67] sticky left-0 z-10 bg-gray-50 dark:bg-[#1c2936] group-hover/header:bg-gray-100 dark:group-hover/header:bg-[#253545]">
            <div class="flex items-center gap-2 overflow-hidden">
              <span class="material-symbols-outlined text-[18px] text-yellow-500">folder</span>
              <span class="font-bold text-xs uppercase text-gray-700 dark:text-gray-200 truncate">{{ group.name
                }}</span>
            </div>
            <div class="flex items-center gap-2">
              <span
                class="text-[10px] bg-gray-200 dark:bg-[#111a22] text-gray-600 dark:text-gray-400 px-1.5 rounded font-bold">{{
                group.units.length }}</span>
              <span class="material-symbols-outlined text-[18px] text-gray-400 transition-transform duration-200"
                [class.-rotate-90]="!group.expanded">expand_more</span>
            </div>
          </div>

          <!-- Timeline Grid for Group (Visual filler) -->
          <div class="flex relative opacity-30">
            @for (day of currentMonthDays(); track day.dayNum) {
            <div class="flex-shrink-0 border-r border-gray-300 dark:border-[#324d67] h-10" [style.width.px]="cellWidth">
            </div>
            }
          </div>
        </div>

        <!-- Units Rows -->
        @if (group.expanded) {
        @for (unit of group.units; track unit.id) {
        <div
          class="flex border-b border-gray-100 dark:border-[#324d67] relative group hover:bg-gray-50 dark:hover:bg-[#253545] transition-colors">

          <!-- Fixed Column (Sticky) - Unit Name -->
          <div (click)="navigateToProperty(unit.id)"
            class="w-48 flex-shrink-0 p-3 pl-8 flex flex-col justify-center border-r border-gray-200 dark:border-[#324d67] bg-white dark:bg-[#1c2936] group-hover:bg-gray-50 dark:group-hover:bg-[#253545] sticky left-0 z-10 transition-colors cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/10">
            <div
              class="font-bold text-sm text-[#111418] dark:text-white truncate group-hover:text-primary transition-colors"
              title="{{ unit.name }}">
              {{ unit.name }}
            </div>
          </div>

          <!-- Grid Cells -->
          <div class="flex relative">
            <!-- Background Grid -->
            @for (day of currentMonthDays(); track day.dayNum) {
            <div
              class="flex-shrink-0 border-r border-gray-100 dark:border-[#324d67] h-16 cursor-crosshair hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
              [style.width.px]="cellWidth" [class.bg-blue-50]="day.isToday" [class.dark:bg-blue-900/10]="day.isToday"
              [class.bg-gray-50]="day.isWeekend && !day.isToday"
              [class.dark:bg-[#18232e]]="day.isWeekend && !day.isToday" (click)="openBookingModal(unit.id, day.date)"
              title="Click to book {{ unit.name }} for {{ day.date | date:'mediumDate' }}"></div>
            }

            <!-- Booking Bars Layer -->
            <div class="absolute inset-0 top-2 bottom-2 pointer-events-none">
              @for (item of getVisibleBookings(unit.id); track item.booking.id) {
              <div
                class="absolute top-1 bottom-1 rounded-md shadow-sm border border-white/10 flex items-center px-2 overflow-hidden pointer-events-auto cursor-pointer hover:brightness-110 transition-all z-0"
                [ngClass]="item.colorClass" [ngStyle]="item.style"
                title="{{ item.booking.guestName }} ({{ item.booking.source }})" (click)="navigateToClient(item.booking)">
                @if (item.booking.source !== 'blocked') {
                <span class="text-[10px] font-bold truncate">{{ item.booking.guestName }}</span>
                } @else {
                <span class="material-symbols-outlined text-[14px]">block</span>
                }
              </div>
              }
            </div>
          </div>

        </div>
        }
        }
        }
      </div>
    </div>
  </div>
</div>

<!-- New Booking Modal -->
@if (isModalOpen()) {
<div
  class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in fixed">
  <div
    class="bg-white dark:bg-[#1c2936] w-full max-w-lg rounded-xl shadow-2xl border border-gray-200 dark:border-[#324d67] overflow-hidden flex flex-col max-h-[90vh]">

    <!-- Modal Header -->
    <div
      class="px-6 py-4 border-b border-gray-200 dark:border-[#324d67] flex items-center justify-between bg-gray-50 dark:bg-[#111a22]">
      <h3 class="text-lg font-bold text-[#111418] dark:text-white flex items-center gap-2">
        <span class="material-symbols-outlined text-green-600">calendar_add_on</span>
        {{ editingBookingId() ? 'Edit Booking' : 'New Booking' }}
      </h3>
      <button (click)="closeBookingModal()"
        class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6 overflow-y-auto space-y-5">

      <!-- Booking Details Section -->
      <div class="space-y-4">
        <h4
          class="text-xs font-bold text-gray-400 uppercase tracking-widest border-b border-gray-200 dark:border-[#324d67] pb-1">
          Booking Details</h4>

        <div class="space-y-1.5">
          <label for="booking-unit" class="text-xs font-bold text-gray-500 uppercase">Unit</label>
          <select id="booking-unit" name="unitId" [ngModel]="bookingForm().unitId"
            (ngModelChange)="bookingForm().unitId = $event"
            class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
            @for (group of calendarGroups(); track group.name) {
            <optgroup [label]="group.name">
              @for (u of group.units; track u.id) {
              <option [value]="u.id">{{ u.name }}</option>
              }
            </optgroup>
            }
          </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1.5">
            <label for="booking-start" class="text-xs font-bold text-gray-500 uppercase">Check-in</label>
            <input id="booking-start" name="startDate" type="date" [ngModel]="bookingForm().startDate"
              (ngModelChange)="bookingForm().startDate = $event"
              class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
          </div>
          <div class="space-y-1.5">
            <label for="booking-end" class="text-xs font-bold text-gray-500 uppercase">Check-out</label>
            <input id="booking-end" name="endDate" type="date" [ngModel]="bookingForm().endDate"
              (ngModelChange)="bookingForm().endDate = $event"
              class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
          </div>
        </div>

        <div class="space-y-1.5">
          <label for="booking-price" class="text-xs font-bold text-gray-500 uppercase">Total Price</label>
          <div class="relative">
            <span class="absolute left-3 top-2 text-gray-500">$</span>
            <input id="booking-price" name="price" type="number" [ngModel]="bookingForm().price"
              (ngModelChange)="bookingForm().price = $event"
              class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md pl-7 pr-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary"
              placeholder="0.00">
          </div>
        </div>
      </div>

      <div class="space-y-1.5">
        <label for="booking-notes" class="text-xs font-bold text-gray-500 uppercase">Notes / Description</label>
        <textarea id="booking-notes" name="notes" [ngModel]="bookingForm().notes"
          (ngModelChange)="bookingForm().notes = $event"
          class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary h-20 resize-none"
          placeholder="Add booking notes..."></textarea>
      </div>

      <!-- Client Section -->
      <div class="space-y-4">
        <h4
          class="text-xs font-bold text-gray-400 uppercase tracking-widest border-b border-gray-200 dark:border-[#324d67] pb-1">
          Client Information</h4>

        <!-- Toggle New/Existing -->
        <div class="flex bg-gray-100 dark:bg-[#111a22] rounded-lg p-1">
          <button (click)="isNewClient.set(false)" class="flex-1 py-1.5 rounded-md text-xs font-bold transition-all"
            [class.bg-white]="!isNewClient()" [class.shadow-sm]="!isNewClient()" [class.text-primary]="!isNewClient()"
            [class.dark:bg-[#253545]]="!isNewClient()" [class.text-gray-500]="isNewClient()">Existing Client</button>
          <button (click)="isNewClient.set(true)" class="flex-1 py-1.5 rounded-md text-xs font-bold transition-all"
            [class.bg-white]="isNewClient()" [class.shadow-sm]="isNewClient()" [class.text-primary]="isNewClient()"
            [class.dark:bg-[#253545]]="isNewClient()" [class.text-gray-500]="!isNewClient()">Create New</button>
        </div>

        @if (!isNewClient()) {
        <div class="space-y-1.5 animate-fade-in">
          <label for="client-select" class="text-xs font-bold text-gray-500 uppercase">Select Client</label>
          <select id="client-select" name="clientId" [ngModel]="selectedClientId()"
            (ngModelChange)="onClientSelect($event)"
            class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
            <option value="" disabled>Search client...</option>
            @for (c of availableClients(); track c.id) {
            <option [value]="c.id">{{ c.name }} ({{ c.phoneNumber }})</option>
            }
          </select>
          <p class="text-[10px] text-gray-400">Select an existing client from your database.</p>
        </div>
        } @else {
        <div class="space-y-3 animate-fade-in">
          <div class="space-y-1.5">
            <label for="client-name" class="text-xs font-bold text-gray-500 uppercase">Full Name</label>
            <input id="client-name" name="clientName" type="text" [ngModel]="newClientForm().name"
              (ngModelChange)="newClientForm().name = $event"
              class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary"
              placeholder="e.g. John Doe">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-1.5">
              <label for="client-phone" class="text-xs font-bold text-gray-500 uppercase">Phone</label>
              <input id="client-phone" name="clientPhone" type="text" [ngModel]="newClientForm().phone"
                (ngModelChange)="newClientForm().phone = $event"
                class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary"
                placeholder="+1234567890">
            </div>
            <div class="space-y-1.5">
              <label for="client-email" class="text-xs font-bold text-gray-500 uppercase">Email (Optional)</label>
              <input id="client-email" name="clientEmail" type="email" [ngModel]="newClientForm().email"
                (ngModelChange)="newClientForm().email = $event"
                class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary"
                placeholder="john@example.com">
            </div>
          </div>
        </div>
        }
      </div>

    </div>

    <!-- Modal Footer -->
    <div
      class="px-6 py-4 bg-gray-50 dark:bg-[#111a22] border-t border-gray-200 dark:border-[#324d67] flex justify-end gap-3">
      <button (click)="closeBookingModal()"
        class="px-4 py-2 text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#253545] rounded-lg transition-colors">Cancel</button>
      <button (click)="saveBooking()"
        class="px-6 py-2 text-sm font-bold text-white bg-primary hover:bg-blue-600 rounded-lg shadow-lg shadow-primary/25 transition-colors">
        {{ editingBookingId() ? 'Save Changes' : 'Create Booking' }}
      </button>
    </div>
  </div>
</div>
}