<div class="flex flex-col animate-fade-in-up pb-8">

  <!-- Header & Controls -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-4">
    <h1 class="text-lg font-bold text-[#111418] dark:text-white">Financial Performance</h1>

    <div class="flex flex-wrap items-center gap-2">

      <!-- Date Filter & Nav -->
      <div
        class="flex items-center bg-white dark:bg-[#1c2936] rounded-lg border border-gray-200 dark:border-[#324d67] p-0.5 shadow-sm">
        <!-- View Toggle -->
        <div class="flex bg-gray-100 dark:bg-[#111a22] rounded-md p-0.5 mr-1.5">
          <button (click)="setFilterMode('month')" class="px-2.5 py-1 text-xs font-bold rounded transition-colors"
            [class.bg-white]="filterMode() === 'month'" [class.shadow-sm]="filterMode() === 'month'"
            [class.text-[#111418]]="filterMode() === 'month'" [class.dark:bg-[#253545]]="filterMode() === 'month'"
            [class.dark:text-white]="filterMode() === 'month'"
            [class.text-gray-500]="filterMode() !== 'month'">Month</button>
          <button (click)="setFilterMode('year')" class="px-2.5 py-1 text-xs font-bold rounded transition-colors"
            [class.bg-white]="filterMode() === 'year'" [class.shadow-sm]="filterMode() === 'year'"
            [class.text-[#111418]]="filterMode() === 'year'" [class.dark:bg-[#253545]]="filterMode() === 'year'"
            [class.dark:text-white]="filterMode() === 'year'"
            [class.text-gray-500]="filterMode() !== 'year'">Year</button>
          <button (click)="setFilterMode('all')" class="px-2.5 py-1 text-xs font-bold rounded transition-colors"
            [class.bg-white]="filterMode() === 'all'" [class.shadow-sm]="filterMode() === 'all'"
            [class.text-[#111418]]="filterMode() === 'all'" [class.dark:bg-[#253545]]="filterMode() === 'all'"
            [class.dark:text-white]="filterMode() === 'all'" [class.text-gray-500]="filterMode() !== 'all'">All</button>
        </div>

        <!-- Navigation (Hidden if All) -->
        @if (filterMode() !== 'all') {
        <button (click)="prevPeriod()"
          class="p-1 hover:bg-gray-100 dark:hover:bg-[#253545] rounded text-gray-500 dark:text-gray-400">
          <span class="material-symbols-outlined text-[16px]">chevron_left</span>
        </button>
        <div class="px-2 font-bold text-xs text-[#111418] dark:text-white min-w-[80px] text-center select-none">
          {{ dateLabel() }}
        </div>
        <button (click)="nextPeriod()"
          class="p-1 hover:bg-gray-100 dark:hover:bg-[#253545] rounded text-gray-500 dark:text-gray-400">
          <span class="material-symbols-outlined text-[16px]">chevron_right</span>
        </button>
        } @else {
        <div class="px-2 font-bold text-xs text-[#111418] dark:text-white min-w-[80px] text-center select-none">
          All History
        </div>
        }
      </div>

      <!-- Currency Switcher -->
      <div class="flex bg-gray-100 dark:bg-[#1c2936] p-0.5 rounded-lg border border-gray-200 dark:border-[#324d67]">
        @for (cur of ['USD', 'UAH', 'EUR']; track cur) {
        <button (click)="setCurrency(cur)" class="px-2.5 py-1 text-xs font-bold rounded-md transition-all"
          [class.bg-primary]="selectedCurrency() === cur" [class.text-white]="selectedCurrency() === cur"
          [class.text-gray-500]="selectedCurrency() !== cur" [class.dark:text-gray-400]="selectedCurrency() !== cur">
          {{ cur }}
        </button>
        }
      </div>

      <!-- Hidden File Input -->
      <input #fileInput type="file" id="pnlImportFile" name="pnlImportFile" (change)="handleImport($event)"
        accept=".xlsx, .xls, .csv" class="hidden">

      <!-- Import Button -->
      <button (click)="fileInput.click()"
        class="flex items-center gap-1.5 bg-white dark:bg-[#253545] border border-gray-200 dark:border-[#324d67] hover:bg-gray-50 dark:hover:bg-[#2f4356] text-[#111418] dark:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-colors">
        <span class="material-symbols-outlined text-[16px]">upload_file</span>
        Import
      </button>

      <button (click)="openManageCategories()"
        class="flex items-center gap-1.5 bg-white dark:bg-[#253545] border border-gray-200 dark:border-[#324d67] hover:bg-gray-50 dark:hover:bg-[#2f4356] text-[#111418] dark:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-colors">
        <span class="material-symbols-outlined text-[16px]">category</span>
        Categories
      </button>

      <button (click)="openAddModal()"
        class="flex items-center gap-1.5 bg-primary hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm shadow-primary/25 active:scale-[0.98]">
        <span class="material-symbols-outlined text-[16px]">add</span>
        Add
      </button>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-2 xl:grid-cols-4 gap-4 mb-4">

    <!-- Total Revenue -->
    <div
      class="bg-white dark:bg-[#1c2936] p-4 rounded-xl border border-gray-200 dark:border-[#324d67] shadow-sm relative overflow-hidden group">
      <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
        <span class="material-symbols-outlined text-4xl text-primary">payments</span>
      </div>
      <p class="text-xs font-bold text-gray-500 mb-1">Revenue</p>
      <h3 class="text-xl font-extrabold text-[#111418] dark:text-white">
        {{ getCurrencySymbol(selectedCurrency()) }}{{ totalRevenue() | number:'1.0-0' }}
      </h3>
      <span class="inline-flex items-center mt-1 text-[10px] font-bold text-green-500">
        {{ transactionCount() }} txns
      </span>
    </div>

    <!-- Total Expenses -->
    <div
      class="bg-white dark:bg-[#1c2936] p-4 rounded-xl border border-gray-200 dark:border-[#324d67] shadow-sm relative overflow-hidden group">
      <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
        <span class="material-symbols-outlined text-4xl text-red-500">trending_down</span>
      </div>
      <p class="text-xs font-bold text-gray-500 mb-1">Expenses</p>
      <h3 class="text-xl font-extrabold text-[#111418] dark:text-white">
        {{ getCurrencySymbol(selectedCurrency()) }}{{ totalExpenses() | number:'1.0-0' }}
      </h3>
    </div>

    <!-- Net Profit -->
    <div
      class="bg-white dark:bg-[#1c2936] p-4 rounded-xl border border-gray-200 dark:border-[#324d67] shadow-sm relative overflow-hidden group">
      <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
        <span class="material-symbols-outlined text-4xl text-blue-400">savings</span>
      </div>
      <p class="text-xs font-bold text-gray-500 mb-1">Net Profit</p>
      <h3 class="text-xl font-extrabold text-[#111418] dark:text-white">
        {{ getCurrencySymbol(selectedCurrency()) }}{{ netProfit() | number:'1.0-0' }}
      </h3>
    </div>

    <!-- Margin -->
    <div
      class="bg-white dark:bg-[#1c2936] p-4 rounded-xl border border-gray-200 dark:border-[#324d67] shadow-sm relative overflow-hidden group">
      <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
        <span class="material-symbols-outlined text-4xl text-purple-400">analytics</span>
      </div>
      <p class="text-xs font-bold text-gray-500 mb-1">Margin</p>
      <h3 class="text-xl font-extrabold text-[#111418] dark:text-white">
        {{ margin() | number:'1.1-1' }}%
      </h3>
    </div>
  </div>

  <!-- Main Content: Split View -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">

    <!-- Left: Category Breakdown -->
    <div
      class="bg-white dark:bg-[#1c2936] rounded-2xl border border-gray-200 dark:border-[#324d67] shadow-sm flex flex-col">
      <div class="px-6 py-5 border-b border-gray-200 dark:border-[#324d67] flex items-center justify-between">
        <h3 class="font-bold text-lg text-[#111418] dark:text-white">Category Breakdown</h3>

        <!-- Download Menu -->
        <div class="relative">
          <button (click)="toggleDownloadMenu()"
            class="text-primary text-sm font-bold hover:underline cursor-pointer flex items-center gap-1">
            Download Report
            <span class="material-symbols-outlined text-[16px]">expand_more</span>
          </button>

          @if (isDownloadMenuOpen()) {
          <!-- Backdrop -->
          <div class="fixed inset-0 z-10 cursor-default" (click)="isDownloadMenuOpen.set(false)"></div>

          <!-- Menu -->
          <div
            class="absolute right-0 top-full mt-1 w-48 bg-white dark:bg-[#1c2936] rounded-xl shadow-xl border border-gray-200 dark:border-[#324d67] z-20 overflow-hidden animate-fade-in flex flex-col">
            <button (click)="downloadReport('xlsx')"
              class="text-left px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-[#253545] text-[#111418] dark:text-white flex items-center gap-2 transition-colors">
              <span class="material-symbols-outlined text-green-600 text-[18px]">table_view</span>
              Excel (.xlsx)
            </button>
            <button (click)="downloadReport('json')"
              class="text-left px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-[#253545] text-[#111418] dark:text-white flex items-center gap-2 border-t border-gray-100 dark:border-[#324d67] transition-colors">
              <span class="material-symbols-outlined text-yellow-600 text-[18px]">data_object</span>
              JSON Data
            </button>
          </div>
          }
        </div>
      </div>

      <div class="p-2">
        <!-- Table Header -->
        <div class="grid grid-cols-12 px-4 py-2 text-xs font-bold text-gray-500 uppercase">
          <div class="col-span-6">Category</div>
          <div class="col-span-3 text-right">Amount ({{ selectedCurrency() }})</div>
          <div class="col-span-3 text-right">Type</div>
        </div>

        <!-- List -->
        @for (cat of categoryBreakdown(); track cat.name) {
        <div class="mb-1">
          <!-- Parent Row -->
          <div (click)="toggleCategory(cat.name)"
            class="grid grid-cols-12 px-4 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-[#253545] cursor-pointer items-center transition-colors group">
            <div class="col-span-6 flex items-center gap-2">
              <span class="material-symbols-outlined text-[16px] text-gray-400 transition-transform duration-200"
                [class.rotate-90]="isExpanded(cat.name)">chevron_right</span>
              <span class="font-bold text-sm text-[#111418] dark:text-white">{{ cat.name }}</span>
            </div>
            <div class="col-span-3 text-right font-mono font-bold text-sm text-[#111418] dark:text-white">
              {{ getCurrencySymbol(selectedCurrency()) }}{{ cat.amount | number:'1.2-2' }}
            </div>
            <div class="col-span-3 text-right">
              <span class="text-[10px] font-extrabold uppercase px-2 py-0.5 rounded"
                [class.text-green-500]="cat.type === 'income'" [class.bg-green-500/10]="cat.type === 'income'"
                [class.text-red-500]="cat.type === 'expense'" [class.bg-red-500/10]="cat.type === 'expense'">
                {{ cat.type }}
              </span>
            </div>
          </div>

          <!-- Children Rows -->
          @if (isExpanded(cat.name)) {
          <div class="space-y-0.5 mt-1 mb-2">
            @for (child of cat.children; track child.name) {
            <div
              class="grid grid-cols-12 px-4 py-2 hover:bg-gray-50 dark:hover:bg-[#253545]/50 text-sm text-gray-500 dark:text-gray-400 transition-colors">
              <div class="col-span-6 pl-10 flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-gray-300 dark:bg-gray-600"></span>
                {{ child.name }}
              </div>
              <div class="col-span-3 text-right font-mono text-xs">
                {{ getCurrencySymbol(selectedCurrency()) }}{{ child.amount | number:'1.2-2' }}
              </div>
              <div class="col-span-3"></div>
            </div>
            }
          </div>
          }
        </div>
        }
        @if (categoryBreakdown().length === 0) {
        <div class="p-8 text-center text-gray-400 italic">No data for this period</div>
        }
      </div>
    </div>

    <!-- Right: Recent Transactions -->
    <div
      class="bg-white dark:bg-[#1c2936] rounded-2xl border border-gray-200 dark:border-[#324d67] shadow-sm flex flex-col">
      <div class="px-6 py-5 border-b border-gray-200 dark:border-[#324d67]">
        <h3 class="font-bold text-lg text-[#111418] dark:text-white">Transactions ({{ dateLabel() }})</h3>
      </div>

      <div class="p-6 space-y-4">
        @for (tx of processedTransactions(); track tx.id) {
        <div
          class="flex items-center justify-between p-4 rounded-xl border border-gray-200 dark:border-[#324d67] bg-gray-50/50 dark:bg-[#111a22]/30 hover:border-primary/30 transition-colors">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="font-bold text-sm text-[#111418] dark:text-white">{{ tx.category }}</span>
              <span class="text-gray-400 text-xs">•</span>
              <span class="text-gray-500 text-sm">{{ tx.subCategory }}</span>
            </div>
            <div class="flex items-center gap-2 text-xs">
              <span class="text-gray-400 font-mono">{{ tx.date }}</span>
              <span class="text-gray-300 dark:text-gray-600">•</span>
              <span class="text-gray-500 font-bold">{{ tx.property }}</span>
            </div>
          </div>
          <div class="text-right">
            <div class="font-mono font-bold text-lg" [class.text-green-500]="tx.type === 'income'"
              [class.text-red-400]="tx.type === 'expense'">
              {{ tx.type === 'income' ? '+' : '-' }}{{ getCurrencySymbol(selectedCurrency()) }}{{ tx.convertedAmount |
              number:'1.2-2' }}
            </div>
            <!-- Show original currency if different -->
            @if (tx.currency !== selectedCurrency()) {
            <div class="text-[10px] text-gray-400 font-mono">
              Orig: {{ getCurrencySymbol(tx.currency) }}{{ tx.amount | number:'1.2-2' }}
            </div>
            }
          </div>
        </div>
        }
        @if (processedTransactions().length === 0) {
        <div class="flex flex-col items-center justify-center h-40 text-gray-400 italic">
          <span class="material-symbols-outlined text-4xl mb-2 opacity-50">receipt_long</span>
          No transactions for {{ dateLabel() }}.
        </div>
        }
      </div>
    </div>
  </div>

  <!-- Add Modal -->
  @if (isModalOpen()) {
  <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
    <div
      class="bg-white dark:bg-[#1c2936] w-full max-w-lg rounded-xl shadow-2xl border border-gray-200 dark:border-[#324d67] overflow-hidden flex flex-col max-h-[90vh]">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-[#324d67] flex items-center justify-between">
        <h3 class="text-lg font-bold text-[#111418] dark:text-white">Add Transaction</h3>
        <button (click)="isModalOpen.set(false)" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="p-6 overflow-y-auto space-y-4">
        <!-- Type Toggle -->
        <div class="flex bg-gray-100 dark:bg-[#111a22] rounded-lg p-1">
          <button (click)="updateNewTx('type', 'income')"
            class="flex-1 py-2 rounded-md text-sm font-bold transition-all"
            [class.bg-white]="newTransaction().type === 'income'"
            [class.text-green-600]="newTransaction().type === 'income'"
            [class.shadow-sm]="newTransaction().type === 'income'"
            [class.text-gray-500]="newTransaction().type !== 'income'"
            [class.dark:bg-[#253545]]="newTransaction().type === 'income'">Revenue</button>
          <button (click)="updateNewTx('type', 'expense')"
            class="flex-1 py-2 rounded-md text-sm font-bold transition-all"
            [class.bg-white]="newTransaction().type === 'expense'"
            [class.text-red-500]="newTransaction().type === 'expense'"
            [class.shadow-sm]="newTransaction().type === 'expense'"
            [class.text-gray-500]="newTransaction().type !== 'expense'"
            [class.dark:bg-[#253545]]="newTransaction().type === 'expense'">Expense</button>
        </div>

        <!-- Date -->
        <div class="space-y-1.5">
          <label class="text-xs font-bold text-gray-500 uppercase">Date</label>
          <input type="date" id="pnlTxDate" name="pnlTxDate" [ngModel]="newTransaction().date"
            (ngModelChange)="updateNewTx('date', $event)"
            class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
        </div>

        <!-- Category & Sub -->
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1.5">
            <label class="text-xs font-bold text-gray-500 uppercase">Category</label>
            <select id="pnlTxCategory" name="pnlTxCategory" [ngModel]="newTransaction().category"
              (ngModelChange)="updateNewTx('category', $event)"
              class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
              <option value="" disabled selected>Select Category</option>
              @for(c of availableCategories(); track c.id) {
              <option [value]="c.name">{{ c.name }}</option>
              }
            </select>
          </div>
          <div class="space-y-1.5">
            <label class="text-xs font-bold text-gray-500 uppercase">Sub-Category</label>
            <select id="pnlTxSubCategory" name="pnlTxSubCategory" [ngModel]="newTransaction().subCategory"
              (ngModelChange)="updateNewTx('subCategory', $event)"
              class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
              <option value="" disabled selected>Select Sub-Category</option>
              @for(sub of availableSubCategories(); track sub.id) {
              <option [value]="sub.name">{{ sub.name }}</option>
              }
            </select>
          </div>
        </div>

        <!-- Amount -->
        <!-- Amount, Currency & Quantity -->
        <div class="grid gap-4" [class.grid-cols-2]="!isInventoryCategorySelected()"
          [class.grid-cols-3]="isInventoryCategorySelected()">

          <!-- Currency -->
          <div class="space-y-1.5">
            <label class="text-xs font-bold text-gray-500 uppercase">Currency</label>
            <select id="pnlTxCurrency" name="pnlTxCurrency" [ngModel]="newTransaction().currency"
              (ngModelChange)="updateNewTx('currency', $event)"
              class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
              <option value="USD">USD</option>
              <option value="UAH">UAH</option>
              <option value="EUR">EUR</option>
            </select>
          </div>

          <!-- Amount -->
          <div class="space-y-1.5">
            <label class="text-xs font-bold text-gray-500 uppercase">Total Amount</label>
            <input type="number" id="pnlTxAmount" name="pnlTxAmount" [ngModel]="newTransaction().amount"
              (ngModelChange)="updateNewTx('amount', $event)"
              class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary"
              placeholder="0.00" min="0" step="0.01">
          </div>

          <!-- Quantity (Inventory only) -->
          @if (isInventoryCategorySelected()) {
          <div class="space-y-1.5 animate-fade-in">
            <label class="text-xs font-bold text-gray-500 uppercase">Quantity</label>
            <input type="number" id="pnlTxQty" name="pnlTxQty" [ngModel]="newTransaction().quantity"
              (ngModelChange)="updateNewTx('quantity', $event)"
              class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary"
              placeholder="Qty" min="1">
            <p class="text-[10px] text-gray-400">
              Unit Price: {{ (newTransaction().amount && newTransaction().quantity ? newTransaction().amount! /
              newTransaction().quantity! : 0) | currency:newTransaction().currency }}
            </p>
          </div>
          }
        </div>

        <!-- Description -->
        <div class="space-y-1.5">
          <label class="text-xs font-bold text-gray-500 uppercase">Description</label>
          <textarea id="pnlTxDescription" name="pnlTxDescription" [ngModel]="newTransaction().description"
            (ngModelChange)="updateNewTx('description', $event)"
            class="w-full bg-gray-50 dark:bg-[#111a22] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-primary resize-none h-20 text-[#111418] dark:text-white"
            placeholder="Optional details..."></textarea>
        </div>
      </div>

      <div
        class="px-6 py-4 bg-gray-50 dark:bg-[#111a22] border-t border-gray-200 dark:border-[#324d67] flex justify-end gap-3">
        <button (click)="isModalOpen.set(false)"
          class="px-4 py-2 text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#253545] rounded-lg">Cancel</button>
        <button (click)="saveTransaction()" [disabled]="!canSaveTransaction()"
          class="px-4 py-2 text-sm font-bold text-white bg-primary hover:bg-blue-600 rounded-lg shadow-lg shadow-primary/25 disabled:opacity-50 disabled:cursor-not-allowed">Save
          Transaction</button>
      </div>
    </div>
  </div>
  }

  <!-- Import Preview Modal -->
  @if (isImportModalOpen()) {
  <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
    <div
      class="bg-white dark:bg-[#1c2936] w-full max-w-6xl rounded-xl shadow-2xl border border-gray-200 dark:border-[#324d67] overflow-hidden flex flex-col max-h-[90vh]">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-[#324d67] flex items-center justify-between">
        <h3 class="text-lg font-bold text-[#111418] dark:text-white">Review Import Data</h3>
        <button (click)="cancelImport()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="flex-1 overflow-auto p-0">
        <table class="w-full text-sm text-left border-collapse">
          <thead class="text-xs text-gray-500 uppercase bg-gray-50 dark:bg-[#111a22] sticky top-0 z-10 shadow-sm">
            <tr>
              <th class="px-4 py-3 font-bold border-b dark:border-[#324d67]">Date</th>
              <th class="px-4 py-3 font-bold border-b dark:border-[#324d67]">Type</th>
              <th class="px-4 py-3 font-bold border-b dark:border-[#324d67]">Property</th>
              <th class="px-4 py-3 font-bold border-b dark:border-[#324d67]">Category</th>
              <th class="px-4 py-3 font-bold border-b dark:border-[#324d67]">Sub Category</th>
              <th class="px-4 py-3 font-bold border-b dark:border-[#324d67]">Description</th>
              <th class="px-4 py-3 font-bold border-b dark:border-[#324d67] text-right">Amount</th>
              <th class="px-4 py-3 font-bold border-b dark:border-[#324d67]">Curr</th>
              <th class="px-4 py-3 font-bold border-b dark:border-[#324d67]"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-[#324d67]">
            @for (item of importPreviewData(); track item.id; let i = $index) {
            <tr class="bg-white dark:bg-[#1c2936] hover:bg-gray-50 dark:hover:bg-[#253545]">
              <td class="p-2">
                <input type="date" [attr.id]="'impDate-' + i" [attr.name]="'impDate-' + i" [ngModel]="item.date"
                  (ngModelChange)="updatePreviewItem(i, 'date', $event)"
                  class="w-32 bg-transparent border border-gray-200 dark:border-[#324d67] text-[#111418] dark:text-white rounded px-2 py-1 text-xs focus:ring-1 focus:ring-primary">
              </td>
              <td class="p-2">
                <select [attr.id]="'impType-' + i" [attr.name]="'impType-' + i" [ngModel]="item.type"
                  (ngModelChange)="updatePreviewItem(i, 'type', $event)"
                  class="bg-transparent border border-gray-200 dark:border-[#324d67] text-[#111418] dark:text-white rounded px-2 py-1 text-xs focus:ring-1 focus:ring-primary">
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                </select>
              </td>
              <td class="p-2">
                <select [attr.id]="'impProp-' + i" [attr.name]="'impProp-' + i" [ngModel]="item.property"
                  (ngModelChange)="updatePreviewItem(i, 'property', $event)"
                  class="w-32 bg-transparent border border-gray-200 dark:border-[#324d67] text-[#111418] dark:text-white rounded px-2 py-1 text-xs focus:ring-1 focus:ring-primary">
                  @for(p of properties; track p) { <option [value]="p">{{p}}</option> }
                </select>
              </td>
              <td class="p-2">
                <select [attr.id]="'impCat-' + i" [attr.name]="'impCat-' + i" [ngModel]="item.category"
                  (ngModelChange)="updatePreviewItem(i, 'category', $event)"
                  class="w-32 bg-transparent border border-gray-200 dark:border-[#324d67] text-[#111418] dark:text-white rounded px-2 py-1 text-xs focus:ring-1 focus:ring-primary">
                  @for(c of categories(); track c.name) { <option [value]="c.name">{{c.name}}</option> }
                </select>
              </td>
              <td class="p-2">
                <input type="text" [attr.id]="'impSubCat-' + i" [attr.name]="'impSubCat-' + i"
                  [ngModel]="item.subCategory" (ngModelChange)="updatePreviewItem(i, 'subCategory', $event)"
                  class="w-24 bg-transparent border border-gray-200 dark:border-[#324d67] text-[#111418] dark:text-white rounded px-2 py-1 text-xs focus:ring-1 focus:ring-primary">
              </td>
              <td class="p-2">
                <input type="text" [attr.id]="'impDesc-' + i" [attr.name]="'impDesc-' + i" [ngModel]="item.description"
                  (ngModelChange)="updatePreviewItem(i, 'description', $event)"
                  class="w-48 bg-transparent border border-gray-200 dark:border-[#324d67] text-[#111418] dark:text-white rounded px-2 py-1 text-xs focus:ring-1 focus:ring-primary">
              </td>
              <td class="p-2 text-right">
                <input type="number" [attr.id]="'impAmount-' + i" [attr.name]="'impAmount-' + i" [ngModel]="item.amount"
                  (ngModelChange)="updatePreviewItem(i, 'amount', $event)"
                  class="w-20 text-right bg-transparent border border-gray-200 dark:border-[#324d67] text-[#111418] dark:text-white rounded px-2 py-1 text-xs focus:ring-1 focus:ring-primary">
              </td>
              <td class="p-2">
                <select [attr.id]="'impCurr-' + i" [attr.name]="'impCurr-' + i" [ngModel]="item.currency"
                  (ngModelChange)="updatePreviewItem(i, 'currency', $event)"
                  class="w-16 bg-transparent border border-gray-200 dark:border-[#324d67] text-[#111418] dark:text-white rounded px-2 py-1 text-xs focus:ring-1 focus:ring-primary">
                  <option value="USD">USD</option>
                  <option value="UAH">UAH</option>
                  <option value="EUR">EUR</option>
                </select>
              </td>
              <td class="p-2 text-center">
                <button (click)="removePreviewItem(i)" class="text-gray-400 hover:text-red-500 transition-colors">
                  <span class="material-symbols-outlined text-[18px]">delete</span>
                </button>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <div
        class="px-6 py-4 bg-gray-50 dark:bg-[#111a22] border-t border-gray-200 dark:border-[#324d67] flex justify-between items-center">
        <div class="text-sm text-gray-500">
          <strong class="text-[#111418] dark:text-white">{{ importPreviewData().length }}</strong> transactions ready to
          import.
        </div>
        <div class="flex gap-3">
          <button (click)="cancelImport()"
            class="px-4 py-2 text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#253545] rounded-lg transition-colors">Discard</button>
          <button (click)="saveImport()"
            class="px-4 py-2 text-sm font-bold text-white bg-primary hover:bg-blue-600 rounded-lg shadow-lg shadow-primary/25 transition-colors">Import
            All</button>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Manage Categories Modal -->
  @if (isManageCategoriesOpen()) {
  <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
    <div
      class="bg-white dark:bg-[#1c2936] w-full max-w-2xl rounded-xl shadow-2xl border border-gray-200 dark:border-[#324d67] overflow-hidden flex flex-col max-h-[90vh]">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-[#324d67] flex items-center justify-between">
        <h3 class="text-lg font-bold text-[#111418] dark:text-white">Manage Categories</h3>
        <button (click)="isManageCategoriesOpen.set(false)"
          class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="flex-1 overflow-y-auto p-6 space-y-6">

        <!-- Add New Category -->
        <div class="bg-gray-50 dark:bg-[#111a22] p-4 rounded-lg flex items-end gap-3">
          <div class="flex-1 space-y-1">
            <label class="text-xs font-bold text-gray-500 uppercase">New Category</label>
            <input type="text" [ngModel]="newCategoryName()" (ngModelChange)="newCategoryName.set($event)"
              placeholder="Category Name"
              class="w-full bg-white dark:bg-[#1c2936] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
          </div>
          <div class="space-y-1">
            <label class="text-xs font-bold text-gray-500 uppercase">Type</label>
            <select [ngModel]="newCategoryType()" (ngModelChange)="newCategoryType.set($event)"
              class="bg-white dark:bg-[#1c2936] border border-gray-200 dark:border-[#324d67] rounded-md px-3 py-2 text-sm text-[#111418] dark:text-white focus:ring-1 focus:ring-primary">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
            </select>
          </div>
          <button (click)="addCategory()"
            class="px-4 py-2 bg-primary text-white text-sm font-bold rounded-md hover:bg-blue-600 transition-colors shadow-sm">
            Add
          </button>
        </div>

        <!-- Categories List -->
        <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
          @for(cat of categories(); track cat.id) {
          <div class="border border-gray-200 dark:border-[#324d67] rounded-lg overflow-hidden">
            <div
              class="bg-gray-50 dark:bg-[#253545] p-3 flex items-center justify-between group hover:bg-gray-100 dark:hover:bg-[#2f4356] transition-colors">

              @if (editingCategoryId() === cat.id) {
              <!-- Edit Mode -->
              <div class="flex items-center gap-2 flex-1">
                <input [(ngModel)]="editingCategoryName"
                  class="flex-1 bg-white dark:bg-[#111418] border border-gray-300 dark:border-[#324d67] rounded px-2 py-1 text-sm text-[#111418] dark:text-white" />
                <select [(ngModel)]="editingCategoryType"
                  class="bg-white dark:bg-[#111418] border border-gray-300 dark:border-[#324d67] rounded px-2 py-1 text-sm text-[#111418] dark:text-white">
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                </select>
                <button (click)="saveEditCategory()"
                  class="text-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 p-1 rounded">
                  <span class="material-symbols-outlined text-[18px]">check</span>
                </button>
                <button (click)="cancelEditCategory()"
                  class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1 rounded">
                  <span class="material-symbols-outlined text-[18px]">close</span>
                </button>
              </div>
              } @else {
              <!-- View Mode -->
              <div class="flex items-center gap-3 cursor-pointer flex-1"
                (click)="selectedCategoryForSub.set(cat.id === selectedCategoryForSub() ? null : cat.id)">
                <span class="material-symbols-outlined text-gray-400 transform transition-transform"
                  [class.rotate-90]="selectedCategoryForSub() === cat.id">chevron_right</span>
                <div class="flex flex-col">
                  <span class="font-medium text-[#111418] dark:text-white">{{cat.name}}</span>
                  <span class="text-xs text-gray-500 uppercase tracking-wider">{{cat.type}}</span>
                </div>
              </div>
              <div class="flex items-center gap-1 transition-opacity">
                <button (click)="startEditCategory(cat)"
                  class="text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 p-1.5 rounded-lg transition-colors"
                  title="Edit Category">
                  <span class="material-symbols-outlined text-[18px]">edit</span>
                </button>
                <button (click)="deleteCategory(cat.id)"
                  class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1.5 rounded-lg transition-colors"
                  title="Delete Category">
                  <span class="material-symbols-outlined text-[18px]">delete</span>
                </button>
              </div>
              }
            </div>

            @if(selectedCategoryForSub() === cat.id) {
            <div class="bg-white dark:bg-[#1c2936] p-3 pl-11 border-t border-gray-200 dark:border-[#324d67]">
              <!-- Add Sub Category -->
              <div class="flex gap-2 mb-3">
                <input type="text" [(ngModel)]="newSubCategoryName" placeholder="New sub-category..."
                  (keydown.enter)="addSubCategory(cat.id)"
                  class="flex-1 bg-gray-50 dark:bg-[#253545] border border-gray-200 dark:border-[#324d67] rounded-lg px-3 py-2 text-sm text-[#111418] dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#6366f1] transition-all">
                <button (click)="addSubCategory(cat.id)"
                  class="bg-[#6366f1] hover:bg-[#4f46e5] text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                  Add
                </button>
              </div>

              <!-- Sub Categories List -->
              <div class="space-y-1">
                @for(sub of cat.subCategories; track sub.id) {
                <div
                  class="flex items-center justify-between py-1 px-2 hover:bg-gray-50 dark:hover:bg-[#253545] rounded group">
                  @if (editingSubCategoryId() === sub.id) {
                  <div class="flex items-center gap-2 flex-1">
                    <input [(ngModel)]="editingSubCategoryName"
                      class="flex-1 bg-white dark:bg-[#111418] border border-gray-300 dark:border-[#324d67] rounded px-2 py-1 text-sm text-[#111418] dark:text-white" />
                    <button (click)="saveEditSubCategory()"
                      class="text-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 p-1 rounded">
                      <span class="material-symbols-outlined text-[16px]">check</span>
                    </button>
                    <button (click)="cancelEditSubCategory()"
                      class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1 rounded">
                      <span class="material-symbols-outlined text-[16px]">close</span>
                    </button>
                  </div>
                  } @else {
                  <span class="text-sm text-gray-600 dark:text-gray-300">{{sub.name}}</span>
                  <div class="flex items-center gap-1 transition-opacity">
                    <button (click)="startEditSubCategory(sub)" class="text-blue-400 hover:text-blue-600 p-1"
                      title="Edit">
                      <span class="material-symbols-outlined text-[16px]">edit</span>
                    </button>
                    <button (click)="deleteSubCategory(sub.id)" class="text-red-400 hover:text-red-600 p-1"
                      title="Delete">
                      <span class="material-symbols-outlined text-[16px]">delete</span>
                    </button>
                  </div>
                  }
                </div>
                }
              </div>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>
  </div>
  }
</div>